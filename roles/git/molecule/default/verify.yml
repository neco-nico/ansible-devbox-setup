---
- name: Verify git role
  hosts: all
  gather_facts: true
  become: false
  tasks:
    # .zshrc
    - name: Verify .zshrc exists
      ansible.builtin.command:
        cmd: test -f {{ ansible_env.HOME }}/.zshrc
      changed_when: false

    # Ansible managed block configuration
    - name: Verify Ansible managed block is properly configured in .zshrc
      ansible.builtin.shell: |
        grep -q "# BEGIN ANSIBLE MANAGED BLOCK - Devbox configuration" {{ ansible_env.HOME }}/.zshrc &&
        grep -q "# END ANSIBLE MANAGED BLOCK - Devbox configuration" {{ ansible_env.HOME }}/.zshrc &&
        grep -q 'source.*\.zshrc\.git-config' {{ ansible_env.HOME }}/.zshrc
      changed_when: false

    # git aliases
    - name: Verify git aliases are configured in git role config file
      ansible.builtin.shell: |
        grep -q "alias gb=" "{{ ansible_env.HOME }}/.zshrc.git-config" &&
        grep -q "alias gc=" "{{ ansible_env.HOME }}/.zshrc.git-config" &&
        grep -q "alias gl=" "{{ ansible_env.HOME }}/.zshrc.git-config" &&
        grep -q "alias gp=" "{{ ansible_env.HOME }}/.zshrc.git-config" &&
        grep -q "alias gph=" "{{ ansible_env.HOME }}/.zshrc.git-config" &&
        grep -q "alias gs=" "{{ ansible_env.HOME }}/.zshrc.git-config" &&
        grep -q "alias gsa=" "{{ ansible_env.HOME }}/.zshrc.git-config" &&
        grep -q "alias gr=" "{{ ansible_env.HOME }}/.zshrc.git-config"
      register: git_aliases_check
      changed_when: false
      failed_when: git_aliases_check.rc != 0

    - name: Display git aliases
      ansible.builtin.debug:
        msg: "Git aliases are configured successfully"

    # Rollback behaviour
    - name: Execute git rollback tasks
      ansible.builtin.include_role:
        name: git
        tasks_from: rollback

    - name: Assert Devbox block removed from .zshrc
      ansible.builtin.shell: |
        grep -q "# BEGIN ANSIBLE MANAGED BLOCK - Devbox configuration" {{ ansible_env.HOME }}/.zshrc
      register: devbox_block_check
      changed_when: false
      failed_when: devbox_block_check.rc == 0
