---
- name: Verify common role
  hosts: all
  gather_facts: true
  tasks:
    # homebrew & tools (only on macOS)
    - name: Verify Homebrew tools are installed
      ansible.builtin.command:
        cmd: "which {{ item }}"
      register: tool_check
      loop:
        - git
        - tig
        - wget
        - gh
        - fzf
        - rg
        - volta
      changed_when: false
      failed_when: false
      when: ansible_os_family == "Darwin"

    - name: Assert all tools are installed
      ansible.builtin.assert:
        that:
          - item.item in ['git', 'tig', 'wget', 'gh', 'fzf', 'rg', 'volta']
          - item.rc == 0
        fail_msg: "Tool {{ item.item }} is not installed or not in PATH"
        success_msg: "All Homebrew tools are installed"
      loop: "{{ tool_check.results }}"
      loop_control:
        label: "{{ item.item }}"
      when: ansible_os_family == "Darwin"

    # .bashrc
    - name: Verify .bashrc exists
      ansible.builtin.command:
        cmd: test -f /home/testuser/.bashrc
      changed_when: false

    # Volta environment variables (only on macOS)
    - name: Verify Volta environment variables are configured
      ansible.builtin.command:
        cmd: |
          grep -q "# BEGIN ANSIBLE MANAGED BLOCK - Volta" /home/testuser/.bashrc &&
          grep -q "# END ANSIBLE MANAGED BLOCK - Volta" /home/testuser/.bashrc &&
          grep -q 'export VOLTA_HOME="$HOME/.volta"' /home/testuser/.bashrc &&
          grep -q 'export PATH="$VOLTA_HOME/bin:$PATH"' /home/testuser/.bashrc
      changed_when: false
      when: ansible_os_family == "Darwin"

    # Node.js (only on macOS)
    - name: Verify Node.js is available
      ansible.builtin.shell: |
        export VOLTA_HOME="$HOME/.volta"
        export PATH="$VOLTA_HOME/bin:$PATH"
        node --version
      changed_when: false
      register: node_version_check
      failed_when: node_version_check.rc != 0
      when: ansible_os_family == "Darwin"

    - name: Display Node.js version
      ansible.builtin.debug:
        msg: "Node.js is available (version: {{ node_version_check.stdout }})"
      when: ansible_os_family == "Darwin"

    # Yarn (only on macOS)
    - name: Verify Yarn is available
      ansible.builtin.shell: |
        export VOLTA_HOME="$HOME/.volta"
        export PATH="$VOLTA_HOME/bin:$PATH"
        yarn --version
      changed_when: false
      register: yarn_version_check
      failed_when: yarn_version_check.rc != 0
      when: ansible_os_family == "Darwin"

    - name: Display Yarn version
      ansible.builtin.debug:
        msg: "Yarn is available (version: {{ yarn_version_check.stdout }})"
      when: ansible_os_family == "Darwin"
