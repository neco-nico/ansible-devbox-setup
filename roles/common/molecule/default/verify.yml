---
- name: Verify common role
  hosts: all
  gather_facts: true
  tasks:
    # Prerequisites: Homebrew installation
    - name: Verify Homebrew is installed
      ansible.builtin.command:
        cmd: command -v brew
      changed_when: false
      register: brew_check
      failed_when: brew_check.rc != 0

    # Prerequisites: Homebrew PATH configuration
    - name: Verify Homebrew PATH is configured in .zprofile
      ansible.builtin.shell: |
        test -f {{ ansible_env.HOME }}/.zprofile &&
        grep -q "# BEGIN ANSIBLE MANAGED BLOCK - Homebrew" {{ ansible_env.HOME }}/.zprofile &&
        grep -q "# END ANSIBLE MANAGED BLOCK - Homebrew" {{ ansible_env.HOME }}/.zprofile &&
        grep -q "brew shellenv" {{ ansible_env.HOME }}/.zprofile
      changed_when: false

    # Prerequisites: Ansible installation
    - name: Verify Ansible is installed
      ansible.builtin.command:
        cmd: command -v ansible
      changed_when: false
      register: ansible_check
      failed_when: ansible_check.rc != 0
      environment:
        PATH: "/opt/homebrew/bin:/usr/local/bin:{{ ansible_env.PATH }}"

    # Prerequisites: Ansible collections installation
    - name: Verify Ansible collections are installed
      ansible.builtin.command:
        cmd: test -d {{ ansible_env.HOME }}/.ansible/collections/ansible_collections/community/general
      changed_when: false

    # homebrew & tools (macOS only)
    - name: Verify Homebrew tools are installed
      ansible.builtin.command:
        cmd: "which {{ item }}"
      register: tool_check
      loop:
        - git
        - tig
        - wget
        - gh
        - fzf
        - rg
        - volta
      changed_when: false
      failed_when: false

    - name: Assert all tools are installed
      ansible.builtin.assert:
        that:
          - item.item in ['git', 'tig', 'wget', 'gh', 'fzf', 'rg', 'volta']
          - item.rc == 0
        fail_msg: "Tool {{ item.item }} is not installed or not in PATH"
        success_msg: "All Homebrew tools are installed"
      loop: "{{ tool_check.results }}"
      loop_control:
        label: "{{ item.item }}"

    # .zshrc (Volta environment variables)
    - name: Verify .zshrc exists
      ansible.builtin.command:
        cmd: test -f {{ ansible_env.HOME }}/.zshrc
      changed_when: false

    # Volta environment variables
    - name: Verify Volta environment variables are configured in .zshrc
      ansible.builtin.shell: |
        grep -q "# BEGIN ANSIBLE MANAGED BLOCK - Volta" {{ ansible_env.HOME }}/.zshrc &&
        grep -q "# END ANSIBLE MANAGED BLOCK - Volta" {{ ansible_env.HOME }}/.zshrc &&
        grep -q 'export VOLTA_HOME="$HOME/.volta"' {{ ansible_env.HOME }}/.zshrc &&
        grep -q 'export PATH="$VOLTA_HOME/bin:$PATH"' {{ ansible_env.HOME }}/.zshrc
      changed_when: false

    # Node.js
    - name: Verify Node.js is available
      ansible.builtin.shell: |
        export VOLTA_HOME="$HOME/.volta"
        export PATH="$VOLTA_HOME/bin:$PATH"
        node --version
      changed_when: false
      register: node_version_check
      failed_when: node_version_check.rc != 0

    # Yarn
    - name: Verify Yarn is available
      ansible.builtin.shell: |
        export VOLTA_HOME="$HOME/.volta"
        export PATH="$VOLTA_HOME/bin:$PATH"
        yarn --version
      changed_when: false
      register: yarn_version_check
      failed_when: false

    # Rollback behaviour
    - name: Execute common rollback tasks
      ansible.builtin.include_role:
        name: common
        tasks_from: rollback

    - name: Stat .zprofile after rollback
      ansible.builtin.stat:
        path: "{{ ansible_env.HOME }}/.zprofile"
      register: zprofile_after

    - name: Assert Homebrew PATH block removed from .zprofile
      ansible.builtin.shell: |
        grep -q "# BEGIN ANSIBLE MANAGED BLOCK - Homebrew" {{ ansible_env.HOME }}/.zprofile
      register: homebrew_block_check
      changed_when: false
      failed_when: homebrew_block_check.rc == 0
      when: zprofile_after.stat.exists

    - name: Stat .zshrc after rollback
      ansible.builtin.stat:
        path: "{{ ansible_env.HOME }}/.zshrc"
      register: zshrc_after

    - name: Assert Volta block removed from .zshrc
      ansible.builtin.shell: |
        grep -q "# BEGIN ANSIBLE MANAGED BLOCK - Volta" {{ ansible_env.HOME }}/.zshrc
      register: zshrc_block_check
      changed_when: false
      failed_when: zshrc_block_check.rc == 0
      when: zshrc_after.stat.exists

    - name: Assert Volta directory removed
      ansible.builtin.command:
        cmd: test ! -d {{ ansible_env.HOME }}/.volta
      changed_when: false
      failed_when: false

    - name: Verify volta command removed from PATH
      ansible.builtin.command:
        cmd: command -v volta
      register: volta_command_check
      changed_when: false
      failed_when: volta_command_check.rc == 0
