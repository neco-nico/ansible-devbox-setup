---
- name: Verify common role
  hosts: all
  gather_facts: true
  tasks:
    # homebrew & tools (macOS only)
    - name: Verify Homebrew tools are installed
      ansible.builtin.command:
        cmd: "which {{ item }}"
      register: tool_check
      loop:
        - git
        - tig
        - wget
        - gh
        - fzf
        - rg
        - volta
      changed_when: false
      failed_when: false

    - name: Assert all tools are installed
      ansible.builtin.assert:
        that:
          - item.item in ['git', 'tig', 'wget', 'gh', 'fzf', 'rg', 'volta']
          - item.rc == 0
        fail_msg: "Tool {{ item.item }} is not installed or not in PATH"
        success_msg: "All Homebrew tools are installed"
      loop: "{{ tool_check.results }}"
      loop_control:
        label: "{{ item.item }}"

    # .zshrc (Volta environment variables)
    - name: Verify .zshrc exists
      ansible.builtin.command:
        cmd: test -f {{ ansible_env.HOME }}/.zshrc
      changed_when: false

    # Volta environment variables
    - name: Verify Volta environment variables are configured in .zshrc
      ansible.builtin.shell: |
        grep -q "# BEGIN ANSIBLE MANAGED BLOCK - Volta" {{ ansible_env.HOME }}/.zshrc &&
        grep -q "# END ANSIBLE MANAGED BLOCK - Volta" {{ ansible_env.HOME }}/.zshrc &&
        grep -q 'export VOLTA_HOME="$HOME/.volta"' {{ ansible_env.HOME }}/.zshrc &&
        grep -q 'export PATH="$VOLTA_HOME/bin:$PATH"' {{ ansible_env.HOME }}/.zshrc
      changed_when: false

    # Node.js
    - name: Verify Node.js is available
      ansible.builtin.shell: |
        export VOLTA_HOME="$HOME/.volta"
        export PATH="$VOLTA_HOME/bin:$PATH"
        node --version
      changed_when: false
      register: node_version_check
      failed_when: node_version_check.rc != 0

    - name: Display Node.js version
      ansible.builtin.debug:
        msg: "Node.js is available (version: {{ node_version_check.stdout }})"

    # Yarn
    - name: Verify Yarn is available
      ansible.builtin.shell: |
        export VOLTA_HOME="$HOME/.volta"
        export PATH="$VOLTA_HOME/bin:$PATH"
        yarn --version
      changed_when: false
      register: yarn_version_check
      failed_when: false

    - name: Display Yarn version
      ansible.builtin.debug:
        msg: "Yarn is available (version: {{ yarn_version_check.stdout }})"
      when: yarn_version_check.rc == 0

    - name: Warn if Yarn is not available
      ansible.builtin.debug:
        msg: "Yarn is not available (this may be expected if not installed via Volta)"
      when: yarn_version_check.rc != 0
