---
# Prerequisites: Install Homebrew if not already installed
- name: Install Homebrew if not already installed
  ansible.builtin.raw: |
    if ! command -v brew &> /dev/null; then
      /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    fi
  changed_when: false
  when: ansible_os_family == "Darwin"

- name: Detect Homebrew installation path
  ansible.builtin.set_fact:
    common_brew_prefix: "{{ '/opt/homebrew' if (ansible_architecture == 'arm64') else '/usr/local' }}"
  when: ansible_os_family == "Darwin"

- name: Add Homebrew to PATH in .zprofile
  ansible.builtin.blockinfile:
    path: "{{ ansible_env.HOME }}/.zprofile"
    block: |
      eval "$({{ common_brew_prefix }}/bin/brew shellenv)"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - Homebrew"
    create: true
    mode: '0644'
  when: ansible_os_family == "Darwin"

- name: Set Homebrew PATH for current session
  ansible.builtin.set_fact:
    common_brew_path: "{{ common_brew_prefix }}/bin:{{ ansible_env.PATH }}"
  when: ansible_os_family == "Darwin"

# Prerequisites: Install Ansible if not already installed
- name: Install Ansible via Homebrew
  community.general.homebrew:
    name: ansible
    state: present
  environment:
    PATH: "{{ common_brew_path | default(ansible_env.PATH) }}"
  when: ansible_os_family == "Darwin"

- name: Get project root directory
  ansible.builtin.set_fact:
    common_project_root: "{{ playbook_dir | default(ansible_env.PWD | default('/tmp')) }}"
  when: ansible_os_family == "Darwin"

- name: Install Ansible collections from requirements.yml
  ansible.builtin.command:
    cmd: ansible-galaxy collection install -r {{ common_project_root }}/requirements.yml
  args:
    creates: "{{ ansible_env.HOME }}/.ansible/collections/ansible_collections/community/general"
  environment:
    PATH: "{{ common_brew_path | default(ansible_env.PATH) }}"
  when: ansible_os_family == "Darwin"

# Main tasks: Install development tools via Homebrew
- name: Install development tools via Homebrew
  community.general.homebrew:
    name:
      - git
      - tig
      - wget
      - gh
      - fzf
      - ripgrep
      - volta
    state: present
  environment:
    PATH: "{{ common_brew_path | default('/opt/homebrew/bin:' + ansible_env.PATH) }}"
  when: ansible_os_family == "Darwin"

- name: Create .zshrc if it doesn't exist
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/.zshrc"
    state: touch
    mode: '0644'
  changed_when: false
  when: ansible_os_family == "Darwin"

- name: Add Volta environment variables to .zshrc
  ansible.builtin.blockinfile:
    path: "{{ ansible_env.HOME }}/.zshrc"
    block: |
      export VOLTA_HOME="$HOME/.volta"
      export PATH="$VOLTA_HOME/bin:$PATH"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - Volta"
    create: true
    mode: '0644'
  when: ansible_os_family == "Darwin"

- name: Initialize Volta and install Node.js
  ansible.builtin.shell: |
    export VOLTA_HOME="$HOME/.volta"
    export PATH="$VOLTA_HOME/bin:$PATH"
    # Initialize volta if needed
    if [ ! -d "$HOME/.volta" ]; then
      volta setup
    fi
    # Install node
    volta install node
  args:
    creates: "{{ ansible_env.HOME }}/.volta/bin/node"
  environment:
    PATH: "/usr/local/opt/volta/bin:/opt/homebrew/bin:$PATH"
  when: ansible_os_family == "Darwin"

- name: Enable corepack and prepare Yarn
  ansible.builtin.shell: |
    export VOLTA_HOME="$HOME/.volta"
    export PATH="$VOLTA_HOME/bin:$PATH"
    corepack enable
    corepack prepare yarn@stable --activate
  args:
    creates: "{{ ansible_env.HOME }}/.volta/bin/yarn"
  environment:
    PATH: "$HOME/.volta/bin:/usr/local/opt/volta/bin:/opt/homebrew/bin:{{ ansible_env.PATH }}"
  changed_when: false
  when: ansible_os_family == "Darwin"
